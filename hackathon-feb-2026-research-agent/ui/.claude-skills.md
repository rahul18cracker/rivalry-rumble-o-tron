# Streamlit UI Debug Guide

## Running the UI

```bash
# Standard run
streamlit run ui/app.py

# If port 8501 is busy
streamlit run ui/app.py --server.port 8502

# Debug mode (auto-reload on changes)
streamlit run ui/app.py --server.runOnSave true
```

## Session State Variables

| Variable | Type | Purpose |
|----------|------|---------|
| `messages` | list | Chat history (user + assistant messages) |
| `current_status` | str | Current processing status |
| `is_processing` | bool | Whether a query is being processed |

## UI Components

### Chat Interface
- `st.chat_message()` - Display message bubbles
- `st.chat_input()` - User input field
- Messages stored in `st.session_state.messages`

### Progress Indication
- Status updates via `progress_callback` function
- Displayed in status placeholder during processing

## Common Issues

### 1. Session State Not Persisting
**Symptom**: Variables reset on rerun
**Fix**: Initialize in `init_session_state()`:
```python
if "messages" not in st.session_state:
    st.session_state.messages = []
```

### 2. UI Freezes During Processing
**Symptom**: No progress updates shown
**Fix**: Use placeholders and callbacks:
```python
status_placeholder = st.empty()
status_placeholder.markdown("ðŸ”„ Processing...")
```

### 3. Chat Input Disabled During Processing
**Symptom**: Can't type while agent runs
**Expected**: This is intentional to prevent duplicate queries
**To Change**: Remove `disabled=st.session_state.is_processing`

### 4. Async/Streamlit Conflicts
**Symptom**: "RuntimeError: This event loop is already running"
**Fix**: Use `asyncio.run()` carefully:
```python
# In Streamlit, wrap async calls
asyncio.run(process_query(prompt))
```

### 5. Rerun Loop
**Symptom**: Page keeps reloading
**Fix**: Only call `st.rerun()` when state actually changes

## Testing Without Full Backend

### Mock Agent Response
```python
async def mock_manager_agent(query, callback=None):
    if callback:
        callback("Parsing request...")
        await asyncio.sleep(1)
        callback("Analyzing financials...")
        await asyncio.sleep(1)
        callback("Researching competitors...")
        await asyncio.sleep(1)

    return """# Mock Report
    This is a test report for: {query}
    """
```

## Styling Tips

### Custom CSS
```python
st.markdown("""
<style>
    /* Progress bar color */
    .stProgress > div > div > div {
        background-color: #4CAF50;
    }

    /* Custom container */
    .research-box {
        background-color: #f0f2f6;
        padding: 20px;
        border-radius: 10px;
    }
</style>
""", unsafe_allow_html=True)
```

### Layout
```python
# Two columns
col1, col2 = st.columns(2)

# Wide layout (set in page config)
st.set_page_config(layout="wide")
```

## Deployment

### Local Development
```bash
streamlit run ui/app.py
```

### Streamlit Cloud
1. Push to GitHub
2. Connect repo to share.streamlit.io
3. Set secrets in Streamlit Cloud dashboard:
   - `ANTHROPIC_API_KEY`
   - `TAVILY_API_KEY`

### Docker
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
EXPOSE 8501
CMD ["streamlit", "run", "ui/app.py"]
```
