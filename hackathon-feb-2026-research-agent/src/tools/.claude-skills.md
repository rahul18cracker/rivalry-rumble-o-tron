# Tools Debug Guide

## Validation Status (2026-02-13)
- **yfinance tools**: VALIDATED - returns real market data for DDOG, DT, CSCO
- **Tavily tools**: VALIDATED - returns web search results with API key

## Tool Inventory

| Tool | File | Purpose | API Key Required | Status |
|------|------|---------|------------------|--------|
| `get_company_financials` | `yfinance_tools.py` | Get financial metrics | No | ✅ Working |
| `get_historical_revenue` | `yfinance_tools.py` | Get revenue history | No | ✅ Working |
| `get_company_comparison` | `yfinance_tools.py` | Compare multiple companies | No | ✅ Working |
| `search_company_info` | `tavily_tools.py` | General company research | Yes (TAVILY_API_KEY) | ✅ Working |
| `search_competitive_analysis` | `tavily_tools.py` | Competitive positioning | Yes (TAVILY_API_KEY) | ✅ Working |
| `search_product_info` | `tavily_tools.py` | Product details | Yes (TAVILY_API_KEY) | ✅ Working |
| `search_market_trends` | `tavily_tools.py` | Market/industry trends | Yes (TAVILY_API_KEY) | ✅ Working |

## CRITICAL: Environment Variables

**IMPORTANT**: Tavily tools require `load_dotenv()` to be called before client creation.

```python
# tavily_tools.py must have this at the top:
from dotenv import load_dotenv
load_dotenv()  # REQUIRED - loads .env file
```

## Testing Data Sources

### yfinance (No API Key)
```bash
source venv/bin/activate
python -c "
from src.tools.yfinance_tools import get_company_financials, get_historical_revenue

# Test all three tickers
for ticker in ['DDOG', 'DT', 'CSCO']:
    result = get_company_financials.invoke({'ticker': ticker})
    print(f'{ticker}: {result.get(\"company_name\")} - MCap: {result.get(\"market_cap\")}')

# Test historical
hist = get_historical_revenue.invoke({'ticker': 'DDOG', 'years': 3})
print(f'Historical: {len(hist.get(\"historical_revenue\", []))} years')
"
```

**Expected output:**
```
DDOG: Datadog, Inc. - MCap: $43.90B
DT: Dynatrace, Inc. - MCap: $11.22B
CSCO: Cisco Systems, Inc. - MCap: $303.64B
Historical: 2 years
```

### Tavily (Needs API Key)
```bash
source venv/bin/activate
python -c "
# Reset cached client
import src.tools.tavily_tools as t
t._tavily_client = None

from src.tools.tavily_tools import search_company_info, search_competitive_analysis

# Test company info
result = search_company_info.invoke({'company_name': 'DataDog'})
print(f'Company search: {len(result.get(\"results\", []))} results')

# Test competitive analysis
result = search_competitive_analysis.invoke({
    'company_name': 'DataDog',
    'competitors': ['Dynatrace', 'Splunk']
})
print(f'Competitive search: {len(result.get(\"results\", []))} results')
"
```

**Expected output:**
```
Company search: 5 results
Competitive search: 5 results
```

## API Key Configuration

### .env file (in project root)
```bash
# Required for Tavily tools
TAVILY_API_KEY=tvly-xxxxxxxxxxxxx

# Required for LLM (Claude)
ANTHROPIC_API_KEY=sk-ant-xxxxxxxxxxxxx
```

### Verify keys are loaded
```python
from src.config import get_config
config = get_config()
errors = config.validate()
print("Errors:" if errors else "All keys loaded:", errors or "OK")
```

### Getting API Keys
- **Tavily**: https://tavily.com (free tier: 1000 requests/month)
- **Anthropic**: https://console.anthropic.com/

## Real Data Captured (2026-02-13)

### Financial Metrics
| Company | Ticker | Market Cap | Revenue TTM | Growth YoY | Gross Margin |
|---------|--------|------------|-------------|------------|--------------|
| Datadog | DDOG | $43.90B | $3.43B | 29.2% | 80.0% |
| Dynatrace | DT | $11.22B | $1.93B | 18.2% | 81.7% |
| Cisco | CSCO | $303.64B | $59.05B | 9.7% | 64.8% |

## Common Issues & Solutions

### 1. "TAVILY_API_KEY not set" Error
**Cause**: dotenv not loaded before Tavily client creation
**Fix**: Ensure `load_dotenv()` is at top of tavily_tools.py
**Also**: Reset cached client after fixing:
```python
import src.tools.tavily_tools as t
t._tavily_client = None
```

### 2. yfinance Returns None Values
**Cause**: Yahoo Finance API may have temporary issues or ticker doesn't exist
**Fix**: Check ticker symbol, add retry logic, or handle None gracefully

### 3. Tool Not Recognized by Agent
**Cause**: Tool not in the TOOLS list passed to `llm.bind_tools()`
**Fix**: Ensure all tools are imported and added to the tools list

### 4. Cached Client Issues
**Cause**: Global `_tavily_client` caches stale/invalid client
**Fix**: Reset before testing:
```python
import src.tools.tavily_tools as t
t._tavily_client = None
```

### 5. Rate Limit Errors
**Cause**: Too many API calls to yfinance or Tavily
**Fix**: Add delays between calls, implement caching

## Rate Limits

| Service | Free Tier | Notes |
|---------|-----------|-------|
| yfinance | Unlimited* | Uses Yahoo Finance public data |
| Tavily | 1000 req/month | Search depth affects quota |

*yfinance has no official rate limit but may throttle heavy usage

## Mock Data for Offline Development

```python
MOCK_FINANCIAL = {
    "DDOG": {
        "company_name": "Datadog, Inc.",
        "ticker": "DDOG",
        "market_cap": "$43.90B",
        "revenue_ttm": "$3.43B",
        "revenue_growth_yoy": "29.2%",
        "gross_margin": "80.0%",
    },
    "DT": {
        "company_name": "Dynatrace, Inc.",
        "ticker": "DT",
        "market_cap": "$11.22B",
        "revenue_ttm": "$1.93B",
        "revenue_growth_yoy": "18.2%",
        "gross_margin": "81.7%",
    },
    "CSCO": {
        "company_name": "Cisco Systems, Inc.",
        "ticker": "CSCO",
        "market_cap": "$303.64B",
        "revenue_ttm": "$59.05B",
        "revenue_growth_yoy": "9.7%",
        "gross_margin": "64.8%",
    },
}
```
