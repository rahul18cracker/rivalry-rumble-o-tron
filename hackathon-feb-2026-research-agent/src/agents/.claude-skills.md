# Agents Debug Guide

## Validation Status (2026-02-13)
- **Financial Agent**: VALIDATED - calls yfinance tools, returns structured JSON
- **Competitor Agent**: VALIDATED - calls Tavily tools, returns competitive analysis
- **Manager Agent**: VALIDATED - orchestrates both agents, synthesizes report

## Agent Inventory

| Agent | File | Purpose | Tools | Status |
|-------|------|---------|-------|--------|
| Manager | `manager.py` | Orchestrates research, delegates to sub-agents | None (orchestration only) | ✅ Working |
| Financial | `financial.py` | Analyzes financial data | yfinance_tools | ✅ Working |
| Competitor | `competitor.py` | Researches competitive positioning | tavily_tools | ✅ Working |

## CRITICAL: LangGraph Message Format

**IMPORTANT**: LangGraph requires proper LangChain message objects, NOT dicts.

```python
# WRONG - will cause "unexpected tool_use_id" errors
messages = [
    {"role": "system", "content": "..."},
    {"role": "user", "content": "..."},
]

# CORRECT - use LangChain message objects
from langchain_core.messages import HumanMessage, SystemMessage

messages = [
    SystemMessage(content="..."),
    HumanMessage(content="..."),
]
```

**State must use `add_messages` reducer**:
```python
from typing import Annotated
from langgraph.graph.message import add_messages

class AgentState(TypedDict):
    messages: Annotated[list, add_messages]  # REQUIRED for proper message handling
    # other fields...
```

## Testing Individual Agents

### Financial Agent
```bash
source venv/bin/activate
python -c "
import src.agents.financial as f
f._financial_agent = None  # Reset cache

from src.agents.financial import run_financial_agent
import asyncio

result = asyncio.run(run_financial_agent(
    'Analyze financial metrics',
    tickers=['DDOG', 'DT', 'CSCO']
))
print(result['response'][:1000])
"
```

### Competitor Agent
```bash
source venv/bin/activate
python -c "
import src.agents.competitor as c
c._competitor_agent = None  # Reset cache
import src.tools.tavily_tools as t
t._tavily_client = None  # Reset cache

from src.agents.competitor import run_competitor_agent
import asyncio

result = asyncio.run(run_competitor_agent(
    'Analyze competitive positioning',
    companies=['DataDog', 'Dynatrace', 'Splunk']
))
print(result['response'][:1000])
"
```

### Manager Agent (Full Orchestration)
```bash
source venv/bin/activate
python -c "
# Reset ALL caches
import src.agents.manager as m
import src.agents.financial as f
import src.agents.competitor as c
import src.tools.tavily_tools as t
m._manager_agent = None
f._financial_agent = None
c._competitor_agent = None
t._tavily_client = None

from src.agents.manager import run_manager_agent
import asyncio

def progress(msg):
    print(f'  → {msg}')

report = asyncio.run(run_manager_agent(
    \"Compare Cisco's observability to DataDog and Dynatrace\",
    progress_callback=progress
))
print(report[:2000])
"
```

## Output Schemas

### Financial Agent Output
```python
{
    "task": "string",
    "tickers": ["DDOG", "DT", "CSCO"],
    "response": "string (LLM response with financial analysis)",
    "message_count": 9  # Typical: 2 initial + tool calls + responses
}
```

### Competitor Agent Output
```python
{
    "task": "string",
    "companies": ["DataDog", "Dynatrace", "Splunk"],
    "response": "string (LLM response with competitive analysis)",
    "message_count": 17  # More messages due to multiple searches
}
```

## Common Issues & Solutions

### 1. "unexpected tool_use_id" Error
**Cause**: Using dict messages instead of LangChain message objects
**Fix**: Use `SystemMessage`, `HumanMessage` from `langchain_core.messages`

### 2. Agent Returns Without Using Tools
**Cause**: Tools not properly bound to LLM
**Fix**: Ensure `llm_with_tools = llm.bind_tools(TOOLS)` is called

### 3. "TAVILY_API_KEY not set" Error
**Cause**: dotenv not loaded before Tavily client creation
**Fix**: Add `load_dotenv()` at top of tavily_tools.py

### 4. Cached Agent Issues
**Cause**: Global agent instance caches stale configuration
**Fix**: Reset cache before testing:
```python
import src.agents.financial as f
f._financial_agent = None
```

### 5. Async/Sync Mismatch
**Cause**: Calling async function without await
**Fix**: Use `asyncio.run()` for sync contexts:
```python
result = asyncio.run(run_financial_agent(task, tickers))
```

## Architecture

```
Manager Agent (LangGraph StateGraph)
├── parse_request (node) - LLM extracts companies/tickers
├── execute_tasks (node) - Runs sub-agents in parallel
│   ├── run_financial_agent (async)
│   └── run_competitor_agent (async)
└── synthesize_report (node) - LLM creates final report

Financial Agent (LangGraph ReAct pattern)
├── agent (node) - LLM decides action
├── tools (node) - Execute yfinance tools
└── Conditional edge: tool_calls → tools, else → END

Competitor Agent (LangGraph ReAct pattern)
├── agent (node) - LLM decides action
├── tools (node) - Execute tavily tools
└── Conditional edge: tool_calls → tools, else → END
```

## Performance Notes

- Financial Agent: ~9 messages, ~10-15 seconds
- Competitor Agent: ~17 messages, ~30-45 seconds (more web searches)
- Full orchestration: ~60-90 seconds total
- Report output: ~7000-8000 characters
